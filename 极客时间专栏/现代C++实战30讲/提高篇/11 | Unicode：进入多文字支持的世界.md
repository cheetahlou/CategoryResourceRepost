<audio id="audio" title="11 | Unicodeï¼šè¿›å…¥å¤šæ–‡å­—æ”¯æŒçš„ä¸–ç•Œ" controls="" preload="none"><source id="mp3" src="https://static001.geekbang.org/resource/audio/93/35/9369e57b6dfc8a3fbb9cc0f02fa7a235.mp3"></audio>

ä½ å¥½ï¼Œæˆ‘æ˜¯å´å’ç‚œã€‚

è¿™ä¸€è®²æˆ‘ä»¬æ¥è®²ä¸€ä¸ªæ–°è¯é¢˜ï¼ŒUnicodeã€‚æˆ‘ä»¬ä¼šä»ç¼–ç çš„å†å²è°ˆèµ·ï¼Œè®¨è®ºç¼–ç¨‹ä¸­å¯¹ä¸­æ–‡å’Œå¤šè¯­è¨€çš„æ”¯æŒï¼Œç„¶åé‡ç‚¹çœ‹ä¸€ä¸‹ C++ ä¸­åº”è¯¥å¦‚ä½•å¤„ç†è¿™äº›é—®é¢˜ã€‚

## ä¸€äº›å†å²

ASCII [1] æ˜¯ä¸€ç§åˆ›ç«‹äº 1963 å¹´çš„ 7 ä½ç¼–ç ï¼Œç”¨ 0 åˆ° 127 ä¹‹é—´çš„æ•°å€¼æ¥ä»£è¡¨æœ€å¸¸ç”¨çš„å­—ç¬¦ï¼ŒåŒ…å«äº†æ§åˆ¶å­—ç¬¦ï¼ˆå¾ˆå¤šåœ¨ä»Šå¤©å·²ä¸å†ä½¿ç”¨ï¼‰ã€æ•°å­—ã€å¤§å°å†™æ‹‰ä¸å­—æ¯ã€ç©ºæ ¼å’ŒåŸºæœ¬æ ‡ç‚¹ã€‚å®ƒåœ¨ç¼–ç ä¸Šå…·æœ‰ç®€å•æ€§ï¼Œå­—æ¯å’Œæ•°å­—çš„ç¼–ç ä½ç½®éå¸¸å®¹æ˜“è®°å¿†ï¼ˆç›¸æ¯”ä¹‹ä¸‹ï¼Œè®¾è®¡ EBCDIC [2] çš„äººæ„Ÿè§‰æ˜¯è„‘å­è¿›äº†æ°´ï¼Œå“¦ä¸ï¼Œè¿›äº†ç©¿å­”å¡ç‰‡äº†ï¼›éš¾æ€ªå®ƒå’Œ IBM çš„é‚£äº›è¿‡æ—¶è€å¤è‘£ä¸€èµ·å·²ç»å‡ ä¹è¢«äººé—å¿˜ï¼‰ã€‚æ—¶è‡³ä»Šæ—¥ï¼ŒASCII å¯ä»¥çœ‹ä½œæ˜¯å­—ç¬¦ç¼–ç çš„åŸºç¡€ï¼Œä¸»è¦çš„ç¼–ç æ–¹å¼éƒ½ä¿æŒç€ä¸ ASCII çš„å…¼å®¹æ€§ã€‚

<img src="https://static001.geekbang.org/resource/image/cc/35/cc7fb695569c7ea460c1b89fc7859735.gif" alt="">

ASCII é‡Œåªæœ‰åŸºæœ¬çš„æ‹‰ä¸å­—æ¯ï¼Œå®ƒæ—¢æ²¡æœ‰å¸¦å˜éŸ³ç¬¦çš„æ‹‰ä¸å­—æ¯ï¼ˆå¦‚ Ã© å’Œ Ã¤ ï¼‰ï¼Œä¹Ÿä¸æ”¯æŒåƒå¸Œè…Šå­—æ¯ï¼ˆå¦‚ Î±ã€Î²ã€Î³ï¼‰ã€è¥¿é‡Œå°”å­—æ¯ï¼ˆå¦‚ ĞŸÑƒÑˆĞºĞ¸Ğ½ï¼‰è¿™æ ·çš„å…¶ä»–æ¬§æ´²æ–‡å­—ï¼ˆä¹Ÿéš¾æ€ªï¼Œæ¯•ç«Ÿå®ƒæ˜¯ American Standard Code for Information Interchangeï¼‰ã€‚å¾ˆå¤šå…¶ä»–ç¼–ç æ–¹å¼çº·çº·åº”è¿è€Œç”Ÿï¼ŒåŒ…æ‹¬ ISO 646 ç³»åˆ—ã€ISO/IEC 8859 ç³»åˆ—ç­‰ç­‰ï¼›å¤§éƒ¨åˆ†ç¼–ç æ–¹å¼éƒ½æ˜¯å¤´ 128 ä¸ªå­—ç¬¦ä¸ ASCII å…¼å®¹ï¼Œå 128 ä¸ªå­—ç¬¦æ˜¯è‡ªå·±çš„æ‰©å±•ï¼Œæ€»å…±æœ€å¤šæ˜¯ 256 ä¸ªå­—ç¬¦ã€‚æ¯æ¬¡åªæœ‰ä¸€å¥—æ–¹å¼å¯ä»¥ç”Ÿæ•ˆï¼Œç§°ä¹‹ä¸ºä¸€ä¸ªä»£ç é¡µï¼ˆcode pageï¼‰ã€‚è¿™ç§åšæ³•ï¼Œåªèƒ½é€‚ç”¨äºæ–‡å­—ç›¸è¿‘ã€ä¸”å­—ç¬¦æ•°ä¸å¤šçš„å›½å®¶ã€‚æ¯”å¦‚ï¼Œä¸‹å›¾è¡¨ç¤ºäº† ISO-8859-1ï¼ˆä¹Ÿç§°ä½œ Latin-1ï¼‰å’Œåé¢çš„ Windows æ‰©å±•ä»£ç é¡µ 1252ï¼ˆä¸‹å›¾ä¸­ç»¿æ¡†éƒ¨åˆ†ä¸º Windows çš„æ‰©å±•ï¼‰ï¼Œå°±åªèƒ½é€‚ç”¨äºè¥¿æ¬§å›½å®¶ã€‚

<img src="https://static001.geekbang.org/resource/image/ab/95/ab06af7037bd09d229efbb693be42195.png" alt="">

æœ€æ—©çš„ä¸­æ–‡å­—ç¬¦é›†æ ‡å‡†æ˜¯ 1980 å¹´çš„å›½æ ‡ GB2312 [3]ï¼Œå…¶ä¸­æ”¶å½•äº† 6763 ä¸ªå¸¸ç”¨æ±‰å­—å’Œ 682 ä¸ªå…¶ä»–ç¬¦å·ã€‚æˆ‘ä»¬å¹³æ—¶ä¼šç”¨åˆ°ç¼–ç  GB2312ï¼Œå…¶å®æ›´æ­£ç¡®çš„åå­—æ˜¯ EUC-CN [4]ï¼Œå®ƒæ˜¯ä¸€ç§ä¸ ASCII å…¼å®¹çš„ç¼–ç æ–¹å¼ã€‚å®ƒç”¨å•å­—èŠ‚è¡¨ç¤º ASCII å­—ç¬¦è€Œç”¨åŒå­—èŠ‚è¡¨ç¤º GB2312 ä¸­çš„å­—ç¬¦ï¼›ç”±äº GB2312 ä¸­æœ¬èº«ä¹Ÿå«æœ‰ ASCII ä¸­åŒ…å«çš„å­—ç¬¦ï¼Œåœ¨ä½¿ç”¨ä¸­é€æ¸å°±å½¢æˆäº†â€œåŠè§’â€å’Œâ€œå…¨è§’â€çš„åŒºåˆ«ã€‚

å›½æ ‡å­—ç¬¦é›†åé¢åˆæœ‰æ‰©å±•ï¼Œè¿™ä¸ªæ‰©å±•åçš„å­—ç¬¦é›†å°±æ˜¯ GBK [5]ï¼Œæ˜¯ä¸­æ–‡ç‰ˆ Windows ä½¿ç”¨çš„æ ‡å‡†ç¼–ç æ–¹å¼ã€‚GB2312 å’Œ GBK æ‰€å ç”¨çš„ç¼–ç ä½ç½®å¯ä»¥å‚çœ‹ä¸‹é¢çš„å›¾ï¼ˆç”± John M. DÅ‚ugosz ä¸º Wikipedia ç»˜åˆ¶ï¼‰ï¼š

<img src="https://static001.geekbang.org/resource/image/da/0f/da18e20f4a929399d63a467760657c0f.png" alt="">

å›¾ä¸­ GBK/1 å’Œ GBK/2 ä¸º GB2312 ä¸­å·²ç»å®šä¹‰çš„åŒºåŸŸï¼Œå…¶ä»–çš„åˆ™æ˜¯åé¢æ·»åŠ çš„å­—ç¬¦ï¼Œæ€»å…±å®šä¹‰äº†ä¸¤ä¸‡å¤šä¸ªç¼–ç ç‚¹ï¼Œæ”¯æŒäº†ç»å¤§éƒ¨åˆ†ç°ä»£æ±‰è¯­ä¸­è¿˜åœ¨ä½¿ç”¨çš„å­—ã€‚

Unicode [6] ä½œä¸ºä¸€ç§ç»Ÿä¸€ç¼–ç çš„åŠªåŠ›ï¼Œè¯ç”Ÿäºå…«åå¹´ä»£æœ«ä¹åå¹´ä»£åˆï¼Œæ ‡å‡†çš„ç¬¬ä¸€ç‰ˆå‡ºç‰ˆäº 1991â€”1992 å¹´ã€‚ç”±äºæœ€åˆå‘æ˜è€…çš„ç›®æ ‡æ”¾å¾—å¤ªä½ï¼ŒåªæœŸæœ›å¯¹æ´»è·ƒä½¿ç”¨ä¸­çš„ç°ä»£æ–‡å­—è¿›è¡Œç¼–ç ï¼Œä»–ä»¬è®¤ä¸º 16 æ¯”ç‰¹çš„â€œå®½ ASCIIâ€å°±å¤Ÿç”¨äº†ã€‚è¿™å°±å¯¼è‡´äº†æ—©æœŸé‡‡çº³ Unicode çš„ç»„ç»‡ï¼Œç‰¹åˆ«æ˜¯å¾®è½¯ï¼Œåœ¨å…¶æ“ä½œç³»ç»Ÿå’Œå·¥å…·é“¾ä¸­å¹¿æ³›é‡‡ç”¨äº† 16 æ¯”ç‰¹çš„ç¼–ç æ–¹å¼ã€‚åœ¨ä»Šå¤©ï¼Œå¾®è½¯çš„ç³»ç»Ÿä¸­å®½å­—ç¬¦ç±»å‹ wchar_t ä»ç„¶æ˜¯ 16 ä½çš„ï¼Œæ“ä½œç³»ç»Ÿåº•å±‚æ¥å£å¤§é‡ä½¿ç”¨ 16 ä½å­—ç¬¦ç¼–ç çš„ APIï¼Œè¯´åˆ° Unicode ç¼–ç æ—¶ä»ç„¶æŒ‡çš„æ˜¯ 16 ä½çš„ç¼–ç  UTF-16ï¼ˆè¿™ä¸€ä¸å¤ªæ­£ç¡®çš„åå­—ï¼Œè·Ÿä¸­æ–‡ GBK ç¼–ç å±…ç„¶å¯ä»¥è¢«å«åš ANSI ç›¸æ¯”ï¼Œå®åœ¨æ˜¯å°å·«è§å¤§å·«äº†ï¼‰ã€‚åœ¨å¾®è½¯ä»¥å¤–çš„ä¸–ç•Œï¼ŒUnicode æœ¬èº«ä¸ä½œç¼–ç åç§°ç”¨ï¼Œå¹¶ä¸”æœ€ä¸»æµçš„ç¼–ç æ–¹å¼å¹¶ä¸æ˜¯ UTF-16ï¼Œè€Œæ˜¯å’Œ ASCII å…¨å…¼å®¹çš„ UTF-8ã€‚

æ—©æœŸ Unicode ç»„ç»‡çš„å¦ä¸€ä¸ªå†³å®šæ˜¯ä¸åŒè¯­è¨€é‡Œçš„åŒä¸€ä¸ªå­—ç¬¦ä½¿ç”¨åŒä¸€ä¸ªç¼–ç ç‚¹ï¼Œæ¥å‡å°‘æ€»ç¼–ç ç‚¹çš„æ•°é‡ã€‚ä¸­æ—¥éŸ©ä¸‰å›½ä½¿ç”¨çš„æ±‰å­—å°±è¿™ä¹ˆè¢«ç»Ÿä¸€äº†ï¼šåƒâ€œå°†â€ã€â€œå¾„â€ã€â€œç½‘â€ç­‰å­—ï¼Œæ¯ä¸ªå­—åœ¨ Unicode ä¸­åªå ä¸€ä¸ªç¼–ç ç‚¹ã€‚è¿™å¯¹ç½‘é¡µçš„å­—ä½“é€‰æ‹©ä¹Ÿé€ æˆäº†ä¸å°‘éº»çƒ¦ï¼Œæ—¶è‡³ä»Šæ—¥æˆ‘ä»¬ä»ç„¶å¯ä»¥çœ‹åˆ°è¿™ä¸ªé—®é¢˜ [7]ã€‚ä¸è¿‡è¿™å’Œæˆ‘ä»¬çš„ä¸»é¢˜æ— å…³ï¼Œå°±ä¸å†å¤šè´¹ç¬”å¢¨äº†ã€‚

## Unicode ç®€ä»‹

Unicode åœ¨ä»Šå¤©å·²ç»å¤§å¤§è¶…å‡ºäº†æœ€åˆçš„ç›®æ ‡ã€‚åˆ° Unicode 12.1 ä¸ºæ­¢ï¼ŒUnicode å·²ç»åŒ…å«äº† 137,994 ä¸ªå­—ç¬¦ï¼Œå›Šæ‹¬æ‰€æœ‰ä¸»è¦è¯­è¨€ï¼ˆä½¿ç”¨ä¸­çš„å’Œå·²ç»ä¸å†ä½¿ç”¨çš„ï¼‰ï¼Œå¹¶åŒ…å«äº†è¡¨æƒ…ç¬¦å·ã€æ•°å­¦ç¬¦å·ç­‰å„ç§ç‰¹æ®Šå­—ç¬¦ã€‚ä»ç„¶è¦æŒ‡å‡ºä¸€ä¸‹ï¼ŒUnicode å­—ç¬¦æ˜¯æ ¹æ®å«ä¹‰æ¥åŒºåˆ†çš„ï¼Œè€Œéæ ¹æ®å­—å½¢ã€‚é™¤äº†å‰é¢æåˆ°è¿‡ä¸­æ—¥éŸ©æ±‰å­—æ²¡æœ‰åˆ†å¼€ï¼Œåƒæ–œä½“ï¼ˆitalicsï¼‰ã€å°å¤§å†™å­—æ¯ï¼ˆsmall capsï¼‰ç­‰æ’ç‰ˆæ•ˆæœåœ¨ Unicode é‡Œä¹Ÿæ²¡æœ‰ç‹¬ç«‹çš„å¯¹åº”ã€‚ä¸è¿‡ï¼Œå› ä¸º Unicode é‡ŒåŒ…å«äº†å¾ˆå¤šæ•°å­¦ã€ç‰©ç†ç­‰è‡ªç„¶ç§‘å­¦ä¸­ä½¿ç”¨çš„ç‰¹æ®Šç¬¦å·ï¼ŒæŸäº›æƒ…å†µä¸‹ä½ ä¹Ÿå¯ä»¥æ‰¾åˆ°å¯¹åº”çš„ç¬¦å·ï¼Œå¯ä»¥ç”¨åœ¨èŠå¤©ä¸­è€é…·ï¼Œå¦‚ ğ’·ğ’¶ğ’¹ï¼ˆä½†ä¸é€‚åˆä¸¥è‚ƒçš„æ’ç‰ˆï¼‰ã€‚

Unicode çš„ç¼–ç ç‚¹æ˜¯ä» 0x0 åˆ° 0x10FFFFï¼Œä¸€å…± 1,114,112 ä¸ªä½ç½®ã€‚ä¸€èˆ¬ç”¨â€œU+â€åé¢è·Ÿ 16 è¿›åˆ¶çš„æ•°å€¼æ¥è¡¨ç¤ºä¸€ä¸ª Unicode å­—ç¬¦ï¼Œå¦‚ U+0020 è¡¨ç¤ºç©ºæ ¼ï¼ŒU+6C49 è¡¨ç¤ºâ€œæ±‰â€ï¼ŒU+1F600 è¡¨ç¤ºâ€œğŸ˜€â€ï¼Œç­‰ç­‰ï¼ˆä¸è¶³å››ä½çš„ä¸€èˆ¬å†™å››ä½ï¼‰ã€‚

Unicode å­—ç¬¦çš„å¸¸è§ç¼–ç æ–¹å¼æœ‰ï¼š

- UTF-32 [8]ï¼š32 æ¯”ç‰¹ï¼Œæ˜¯ç¼–ç ç‚¹çš„ç›´æ¥æ˜ å°„ã€‚
- UTF-16 [9]ï¼šå¯¹äºä» U+0000 åˆ° U+FFFF çš„å­—ç¬¦ï¼Œä½¿ç”¨ 16 æ¯”ç‰¹çš„ç›´æ¥æ˜ å°„ï¼›å¯¹äºå¤§äº U+FFFF çš„å­—ç¬¦ï¼Œä½¿ç”¨ 32 æ¯”ç‰¹çš„ç‰¹æ®Šæ˜ å°„å…³ç³»â€”â€”åœ¨ Unicode çš„ 16 æ¯”ç‰¹ç¼–ç ç‚¹ä¸­ 0xD800â€“0xDFFF æ˜¯ä¸€æ®µç©ºéš™ï¼Œä½¿å¾—è¿™ç§å˜é•¿ç¼–ç æˆä¸ºå¯èƒ½ã€‚åœ¨ä¸€ä¸ª UTF-16 çš„åºåˆ—ä¸­ï¼Œå¦‚æœçœ‹åˆ°å†…å®¹æ˜¯ 0xD800â€“0xDBFFï¼Œé‚£è¿™å°±æ˜¯ 32 æ¯”ç‰¹ç¼–ç çš„å‰ 16 æ¯”ç‰¹ï¼›å¦‚æœçœ‹åˆ°å†…å®¹æ˜¯ 0xDC00â€“0xDFFFï¼Œé‚£è¿™æ˜¯ 32 æ¯”ç‰¹ç¼–ç çš„å 16 æ¯”ç‰¹ï¼›å¦‚æœå†…å®¹åœ¨ 0xD800â€“0xDFFF ä¹‹å¤–ï¼Œé‚£å°±æ˜¯ä¸€ä¸ª 16 æ¯”ç‰¹çš„æ˜ å°„ã€‚
- UTF-8 [10]ï¼š1 åˆ° 4 å­—èŠ‚çš„å˜é•¿ç¼–ç ã€‚åœ¨ä¸€ä¸ªåˆæ³•çš„ UTF-8 çš„åºåˆ—ä¸­ï¼Œå¦‚æœçœ‹åˆ°ä¸€ä¸ªå­—èŠ‚çš„æœ€é«˜ä½æ˜¯ 0ï¼Œé‚£å°±æ˜¯ä¸€ä¸ªå•å­—èŠ‚çš„ Unicode å­—ç¬¦ï¼›å¦‚æœä¸€ä¸ªå­—èŠ‚çš„æœ€é«˜ä¸¤æ¯”ç‰¹æ˜¯ 10ï¼Œé‚£è¿™æ˜¯ä¸€ä¸ª Unicode å­—ç¬¦åœ¨ç¼–ç åçš„åç»­å­—èŠ‚ï¼›å¦åˆ™ï¼Œè¿™å°±æ˜¯ä¸€ä¸ª Unicode å­—ç¬¦åœ¨ç¼–ç åçš„é¦–å­—èŠ‚ï¼Œä¸”æœ€é«˜ä½å¼€å§‹è¿ç»­ 1 çš„ä¸ªæ•°è¡¨ç¤ºäº†è¿™ä¸ªå­—ç¬¦æŒ‰ UTF-8 çš„æ–¹å¼ç¼–ç æœ‰å‡ ä¸ªå­—èŠ‚ã€‚

åœ¨ä¸Šé¢ä¸‰ç§ç¼–ç æ–¹å¼é‡Œï¼Œåªæœ‰ UTF-8 å®Œå…¨ä¿æŒäº†å’Œ ASCII çš„å…¼å®¹æ€§ï¼Œç›®å‰å¾—åˆ°äº†æœ€å¹¿æ³›çš„ä½¿ç”¨ã€‚åœ¨æˆ‘ä»¬ä¸‹é¢è®²å…·ä½“ç¼–ç æ–¹å¼ä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆçœ‹ä¸€ä¸‹ä¸Šé¢æåˆ°çš„ä¸‰ä¸ªå­—ç¬¦åœ¨è¿™ä¸‰ç§æ–¹å¼ä¸‹çš„ç¼–ç ç»“æœï¼š

- UTF-32ï¼šU+0020 æ˜ å°„ä¸º 0x00000020ï¼ŒU+6C49 æ˜ å°„ä¸º 0x00006C49ï¼ŒU+1F600 æ˜ å°„ä¸º 0x0001F600ã€‚
- UTF-16ï¼šU+0020 æ˜ å°„ä¸º 0x0020ï¼ŒU+6C49 æ˜ å°„ä¸º 0x6C49ï¼Œè€Œ U+1F600 ä¼šæ˜ å°„ä¸º 0xD83D DE00ã€‚
- UTF-8ï¼šU+0020 æ˜ å°„ä¸º 0x20ï¼ŒU+6C49 æ˜ å°„ä¸º 0xE6 B1 89ï¼Œè€Œ U+1F600 ä¼šæ˜ å°„ä¸º 0xF0 9F 98 80ã€‚

Unicode æœ‰å¥½å‡ ç§ï¼ˆä¸Šé¢è¿˜ä¸æ˜¯å…¨éƒ¨ï¼‰ä¸åŒçš„ç¼–ç æ–¹å¼ï¼Œä¸Šé¢çš„ 16 æ¯”ç‰¹å’Œ 32 æ¯”ç‰¹ç¼–ç æ–¹å¼è¿˜æœ‰å°å¤´å…šå’Œå¤§å¤´å…šä¹‹äº‰ï¼ˆâ€œæ±‰â€æŒ‰å­—èŠ‚è¯»å–æ—¶æ˜¯ 6C 49 å‘¢ï¼Œè¿˜æ˜¯ 49 6Cï¼Ÿï¼‰ï¼›åŒæ—¶ï¼Œä»»ä½•ä¸€ç§ç¼–ç æ–¹å¼è¿˜éœ€è¦è·Ÿä¼ ç»Ÿçš„ç¼–ç æ–¹å¼å®¹æ˜“åŒºåˆ†ã€‚å› æ­¤ï¼ŒUnicode æ–‡æœ¬æ–‡ä»¶é€šå¸¸æœ‰ä¸€ä¸ªä½¿ç”¨ BOMï¼ˆbyte order markï¼‰å­—ç¬¦çš„çº¦å®šï¼Œå³å­—ç¬¦ U+FEFF [11]ã€‚ç”±äº Unicode ä¸ä½¿ç”¨ U+FFFEï¼Œåœ¨æ–‡ä»¶å¼€å¤´åŠ ä¸€ä¸ª BOM å³å¯åŒºåˆ†å„ç§ä¸åŒç¼–ç ï¼š

- å¦‚æœæ–‡ä»¶å¼€å¤´æ˜¯ 0x00 00 FE FFï¼Œé‚£è¿™æ˜¯å¤§å¤´åœ¨å‰çš„ UTF-32 ç¼–ç ï¼›
- å¦åˆ™å¦‚æœæ–‡ä»¶å¼€å¤´æ˜¯ 0xFF FE 00 00ï¼Œé‚£è¿™æ˜¯å°å¤´åœ¨å‰çš„ UTF-32 ç¼–ç ï¼›
- å¦åˆ™å¦‚æœæ–‡ä»¶å¼€å¤´æ˜¯ 0xFE FFï¼Œé‚£è¿™æ˜¯å¤§å¤´åœ¨å‰çš„ UTF-16 ç¼–ç ï¼›
- å¦åˆ™å¦‚æœæ–‡ä»¶å¼€å¤´æ˜¯ 0xFF FEï¼Œé‚£è¿™æ˜¯å°å¤´åœ¨å‰çš„ UTF-16 ç¼–ç ï¼ˆæ³¨æ„ï¼Œè¿™æ¡è§„åˆ™å’Œç¬¬äºŒæ¡çš„é¡ºåºä¸èƒ½ç›¸åï¼‰ï¼›
- å¦åˆ™å¦‚æœæ–‡ä»¶å¼€å¤´æ˜¯ 0xEF BB BFï¼Œé‚£è¿™æ˜¯ UTF-8 ç¼–ç ï¼›
- å¦åˆ™ï¼Œç¼–ç æ–¹å¼ä½¿ç”¨å…¶ä»–ç®—æ³•æ¥ç¡®å®šã€‚

ç¼–è¾‘å™¨å¯ä»¥ï¼ˆæœ‰äº›åœ¨é…ç½®ä¹‹åï¼‰æ ¹æ® BOM å­—ç¬¦æ¥è‡ªåŠ¨å†³å®šæ–‡æœ¬æ–‡ä»¶çš„ç¼–ç ã€‚æ¯”å¦‚ï¼Œæˆ‘ä¸€èˆ¬åœ¨ Vim ä¸­é…ç½® `set fileencodings=ucs-bom,utf-8,gbk,latin1`ã€‚è¿™æ ·ï¼ŒVim åœ¨è¯»å…¥æ–‡ä»¶æ—¶ï¼Œä¼šé¦–å…ˆæ£€æŸ¥ BOM å­—ç¬¦ï¼Œæœ‰ BOM å­—ç¬¦æŒ‰ BOM å­—ç¬¦å†³å®šæ–‡ä»¶ç¼–ç ï¼›å¦åˆ™ï¼Œè¯•å›¾å°†æ–‡ä»¶æŒ‰ UTF-8 æ¥è§£ç ï¼ˆç”±äº UTF-8 æœ‰æ ¼å¼è¦æ±‚ï¼Œé UTF-8 ç¼–ç çš„æ–‡ä»¶é€šå¸¸ä¼šå¯¼è‡´å¤±è´¥ï¼‰ï¼›ä¸è¡Œï¼Œåˆ™è¯•å›¾æŒ‰ GBK æ¥è§£ç ï¼ˆå¤±è´¥çš„æ¦‚ç‡å°±å¾ˆä½äº†ï¼‰ï¼›è¿˜ä¸è¡Œï¼Œå°±æŠŠæ–‡ä»¶å½“ä½œ Latin1 æ¥å¤„ç†ï¼ˆæ°¸è¿œä¸ä¼šå¤±è´¥ï¼‰ã€‚

åœ¨ UTF-8 ç¼–ç ä¸‹ä½¿ç”¨ BOM å­—ç¬¦å¹¶éå¿…éœ€ï¼Œå°¤å…¶åœ¨ Unix ä¸Šã€‚ä½† Windows ä¸Šé€šå¸¸ä¼šä½¿ç”¨ BOM å­—ç¬¦ï¼Œä»¥æ–¹ä¾¿åŒºåˆ† UTF-8 å’Œä¼ ç»Ÿç¼–ç ã€‚

## C++ ä¸­çš„ Unicode å­—ç¬¦ç±»å‹

C++98 ä¸­æœ‰ `char` å’Œ `wchar_t` ä¸¤ç§ä¸åŒçš„å­—ç¬¦ç±»å‹ï¼Œå…¶ä¸­ `char` çš„é•¿åº¦æ˜¯å•å­—èŠ‚ï¼Œè€Œ `wchar_t` çš„é•¿åº¦ä¸ç¡®å®šã€‚åœ¨ Windows ä¸Šå®ƒæ˜¯åŒå­—èŠ‚ï¼Œåªèƒ½ä»£è¡¨ UTF-16ï¼Œè€Œåœ¨ Unix ä¸Šä¸€èˆ¬æ˜¯å››å­—èŠ‚ï¼Œå¯ä»¥ä»£è¡¨ UTF-32ã€‚ä¸ºäº†è§£å†³è¿™ç§æ··ä¹±ï¼Œç›®å‰æˆ‘ä»¬æœ‰äº†ä¸‹é¢çš„æ”¹è¿›ï¼š

- C++11 å¼•å…¥äº† `char16_t` å’Œ `char32_t` ä¸¤ä¸ªç‹¬ç«‹çš„å­—ç¬¦ç±»å‹ï¼ˆä¸æ˜¯ç±»å‹åˆ«åï¼‰ï¼Œåˆ†åˆ«ä»£è¡¨ UTF-16 å’Œ UTF-32ã€‚
- C++20 å°†å¼•å…¥ `char8_t` ç±»å‹ï¼Œè¿›ä¸€æ­¥åŒºåˆ†äº†å¯èƒ½ä½¿ç”¨ä¼ ç»Ÿç¼–ç çš„çª„å­—ç¬¦ç±»å‹å’Œ UTF-8 å­—ç¬¦ç±»å‹ã€‚
- é™¤äº† `string` å’Œ `wstring`ï¼Œæˆ‘ä»¬ä¹Ÿç›¸åº”åœ°æœ‰äº† `u16string`ã€`u32string`ï¼ˆå’Œå°†æ¥çš„ `u8string`ï¼‰ã€‚
- é™¤äº†ä¼ ç»Ÿçš„çª„å­—ç¬¦/å­—ç¬¦ä¸²å­—é¢é‡ï¼ˆå¦‚ `"hi"`ï¼‰å’Œå®½å­—ç¬¦/å­—ç¬¦ä¸²å­—é¢é‡ï¼ˆå¦‚ `L"hi"`ï¼‰ï¼Œå¼•å…¥äº†æ–°çš„ UTF-8ã€UTF-16 å’Œ UTF-32 å­—é¢é‡ï¼Œåˆ†åˆ«å½¢å¦‚ `u8"hi"`ã€`u"hi"` å’Œ `U"hi"`ã€‚
- ä¸ºäº†ç¡®ä¿é ASCII å­—ç¬¦åœ¨æºä»£ç ä¸­å¯ä»¥ç®€å•åœ°è¾“å…¥ï¼Œå¼•å…¥äº†æ–°çš„ Unicode æ¢ç åºåˆ—ã€‚æ¯”å¦‚ï¼Œæˆ‘ä»¬å‰é¢è¯´åˆ°çš„ä¸‰ä¸ªå­—ç¬¦å¯ä»¥è¿™æ ·è¡¨è¾¾æˆä¸€ä¸ª UTF-32 å­—ç¬¦ä¸²å­—é¢é‡ï¼š`U" \u6C49\U0001F600"`ã€‚è¦ç”Ÿæˆ UTF-16 æˆ– UTF-8 å­—ç¬¦ä¸²å­—é¢é‡åªéœ€è¦æ›´æ”¹å‰ç¼€å³å¯ã€‚

ä½¿ç”¨è¿™äº›æ–°çš„å­—ç¬¦ï¼ˆä¸²ï¼‰ç±»å‹ï¼Œæˆ‘ä»¬å¯ä»¥ç”¨ä¸‹é¢çš„ä»£ç è¡¨è¾¾å‡º UTF-32 å’Œå…¶ä»–ä¸¤ç§ UTF ç¼–ç é—´æ˜¯å¦‚ä½•è½¬æ¢çš„ï¼š

```
#include &lt;iomanip&gt;
#include &lt;iostream&gt;
#include &lt;stdexcept&gt;
#include &lt;string&gt;

using namespace std;

const char32_t unicode_max =
  0x10FFFF;

void to_utf_16(char32_t ch,
               u16string&amp; result)
{
  if (ch &gt; unicode_max) {
    throw runtime_error(
      "invalid code point");
  }
  if (ch &lt; 0x10000) {
    result += char16_t(ch);
  } else {
    char16_t first =
      0xD800 |
      ((ch - 0x10000) &gt;&gt; 10);
    char16_t second =
      0xDC00 | (ch &amp; 0x3FF);
    result += first;
    result += second;
  }
}

void to_utf_8(char32_t ch,
              string&amp; result)
{
  if (ch &gt; unicode_max) {
    throw runtime_error(
      "invalid code point");
  }
  if (ch &lt; 0x80) {
    result += ch;
  } else if (ch &lt; 0x800) {
    result += 0xC0 | (ch &gt;&gt; 6);
    result += 0x80 | (ch &amp; 0x3F);
  } else if (ch &lt; 0x10000) {
    result += 0xE0 | (ch &gt;&gt; 12);
    result +=
      0x80 | ((ch &gt;&gt; 6) &amp; 0x3F);
    result += 0x80 | (ch &amp; 0x3F);
  } else {
    result += 0xF0 | (ch &gt;&gt; 18);
    result +=
      0x80 | ((ch &gt;&gt; 12) &amp; 0x3F);
    result +=
      0x80 | ((ch &gt;&gt; 6) &amp; 0x3F);
    result += 0x80 | (ch &amp; 0x3F);
  }
}

int main()
{
  char32_t str[] =
    U" \u6C49\U0001F600";
  u16string u16str;
  string u8str;
  for (auto ch : str) {
    if (ch == 0) {
      break;
    }
    to_utf_16(ch, u16str);
    to_utf_8(ch, u8str);
  }
  cout &lt;&lt; hex &lt;&lt; setfill('0');
  for (char16_t ch : u16str) {
    cout &lt;&lt; setw(4) &lt;&lt; unsigned(ch)
         &lt;&lt; ' ';
  }
  cout &lt;&lt; endl;
  for (unsigned char ch : u8str) {
    cout &lt;&lt; setw(2) &lt;&lt; unsigned(ch)
         &lt;&lt; ' ';
  }
  cout &lt;&lt; endl;
}

```

è¾“å‡ºç»“æœæ˜¯ï¼š

> 
<p>`0020 6c49 d83d de00`<br>
`20 e6 b1 89 f0 9f 98 80`</p>


## å¹³å°åŒºåˆ«

ä¸‹é¢æˆ‘ä»¬çœ‹ä¸€ä¸‹åœ¨ä¸¤ä¸ªä¸»æµçš„å¹³å°ä¸Šä¸€èˆ¬æ˜¯å¦‚ä½•å¤„ç† Unicode ç¼–ç é—®é¢˜çš„ã€‚

### Unix

ç°ä»£ Unix ç³»ç»Ÿï¼ŒåŒ…æ‹¬ Linux å’Œ macOS åœ¨å†…ï¼Œå·²ç»å…¨é¢è½¬å‘äº† UTF-8ã€‚è¿™æ ·çš„ç³»ç»Ÿä¸­ä¸€èˆ¬ç›´æ¥ä½¿ç”¨ `char[]` å’Œ `string` æ¥ä»£è¡¨ UTF-8 å­—ç¬¦ä¸²ï¼ŒåŒ…æ‹¬è¾“å…¥ã€è¾“å‡ºå’Œæ–‡ä»¶åï¼Œéå¸¸ç®€å•ã€‚ä¸è¿‡ï¼Œç”±äºä¸€ä¸ªå­—ç¬¦å•ä½ä¸èƒ½ä»£è¡¨ä¸€ä¸ªå®Œæ•´çš„ Unicode å­—ç¬¦ï¼Œåœ¨éœ€è¦çœŸæ­£è¿›è¡Œæ–‡å­—å¤„ç†çš„åœºåˆè½¬æ¢åˆ° UTF-32 å¾€å¾€ä¼šæ›´ç®€å•ã€‚åœ¨ä»¥å‰åŠéœ€è¦å’Œ C å…¼å®¹çš„åœºåˆï¼Œä¼šä½¿ç”¨ `wchar_t`ã€`uint32_t` æˆ–æŸä¸ªç­‰ä»·çš„ç±»å‹åˆ«åï¼›åœ¨æ–°çš„çº¯ C++ ä»£ç é‡Œï¼Œå°±æ²¡æœ‰ç†ç”±ä¸ä½¿ç”¨ `char32_t` å’Œ `u32string` äº†ã€‚

Unix ä¸‹è¾“å‡ºå®½å­—ç¬¦ä¸²éœ€è¦ä½¿ç”¨ `wcout`ï¼ˆè¿™ç‚¹å’Œ Windows ç›¸åŒï¼‰ï¼Œå¹¶ä¸”éœ€è¦è¿›è¡ŒåŒºåŸŸè®¾ç½®ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š

```
std::locale::global(
    std::locale(""));
std::wcout.imbue(std::locale());

```

ç”±äºæ²¡æœ‰ä»€ä¹ˆé¢å¤–å¥½å¤„ï¼Œåè€Œå¯èƒ½åœ¨æŸäº›ç¯å¢ƒå› ä¸ºåŒºåŸŸè®¾ç½®å¤±è´¥è€Œå¼•å‘é—®é¢˜ï¼ŒUnix å¹³å°ä¸‹ä¸€èˆ¬åªç”¨ `cout`ï¼Œä¸ç”¨ `wcout`ã€‚

### Windows

Windows ç”±äºå†å²åŸå› å’Œä¿ç•™å‘åå…¼å®¹æ€§çš„éœ€è¦ï¼ˆWindows ä¸ºäº†å‘åå…¼å®¹æ€§å·²ç»åˆ°äº†å¤§è§„æ¨¡æ”¾å¼ƒä¼˜é›…çš„ç¨‹åº¦äº†ï¼‰ï¼Œä¸€ç›´ç”¨ `char` è¡¨ç¤ºä¼ ç»Ÿç¼–ç ï¼ˆå¦‚ï¼Œè‹±æ–‡ Windows ä¸Šæ˜¯ Windows-1252ï¼Œç®€ä½“ä¸­æ–‡ Windows ä¸Šæ˜¯ GBKï¼‰ï¼Œç”¨ `wchar_t` è¡¨ç¤º UTF-16ã€‚ç”±äºä¼ ç»Ÿç¼–ç ä¸€æ¬¡åªæœ‰ä¸€ç§ã€ä¸”éœ€è¦é‡å¯æ‰èƒ½ç”Ÿæ•ˆï¼Œè¦å¾—åˆ°å¥½çš„å¤šè¯­è¨€æ”¯æŒï¼Œåœ¨å’Œæ“ä½œç³»ç»Ÿäº¤äº’æ—¶å¿…é¡»ä½¿ç”¨ UTF-16ã€‚

å¯¹äºçº¯ Windows ç¼–ç¨‹ï¼Œå…¨é¢ä½¿ç”¨å®½å­—ç¬¦ï¼ˆä¸²ï¼‰æ˜¯æœ€ç®€å•çš„å¤„ç†æ–¹å¼ã€‚å½“ç„¶ï¼Œæºä»£ç å’Œæ–‡æœ¬å¾ˆå°‘ç”¨ UTF-16 å­˜å‚¨ï¼Œé€šå¸¸è¿˜æ˜¯ UTF-8ï¼ˆé™¤éæ˜¯çº¯ ASCIIï¼Œå¦åˆ™å¿…é¡»åŠ å…¥ BOM å­—ç¬¦æ¥å’Œä¼ ç»Ÿç¼–ç ç›¸åŒºåˆ†ï¼‰ã€‚è¿™æ—¶å¯èƒ½ä¼šæœ‰ä¸€ä¸ªå°å°çš„ä»¤äººæƒŠè®¶çš„åœ°æ–¹ï¼šå¾®è½¯çš„ç¼–è¯‘å™¨ä¼šæŠŠæºä»£ç é‡Œçª„å­—ç¬¦ä¸²å­—é¢é‡ä¸­çš„é ASCII å­—ç¬¦è½¬æ¢æˆä¼ ç»Ÿç¼–ç ã€‚æ¢å¥è¯è¯´ï¼ŒåŒæ ·çš„æºä»£ç åœ¨ä¸åŒç¼–ç çš„ Windows ä¸‹ç¼–è¯‘å¯èƒ½ä¼šäº§ç”Ÿä¸åŒçš„ç»“æœï¼å¦‚æœä½ å¸Œæœ›ä¿ç•™ UTF-8 åºåˆ—çš„è¯ï¼Œå°±åº”è¯¥ä½¿ç”¨ UTF-8 å­—é¢é‡ï¼ˆå¹¶åœ¨å°†æ¥ä½¿ç”¨ `char8_t` å­—ç¬¦ç±»å‹ï¼‰ã€‚

```
#include &lt;stdio.h&gt;

template &lt;typename T&gt;
void dump(const T&amp; str)
{
  for (char ch : str) {
    printf(
      "%.2x ",
      static_cast&lt;unsigned char&gt;(ch));
  }
  putchar('\n');
}

int main()
{
  char str[] = "ä½ å¥½";
  char u8str[] = u8"ä½ å¥½";
  dump(str);
  dump(u8str);
}

```

ä¸‹é¢å±•ç¤ºçš„æ˜¯ä»¥ä¸Šä»£ç åœ¨ Windows ä¸‹ç³»ç»Ÿä¼ ç»Ÿç¼–ç è®¾ç½®ä¸ºç®€ä½“ä¸­æ–‡æ—¶çš„ç¼–è¯‘ã€è¿è¡Œç»“æœï¼š

> 
<p>`c4 e3 ba c3 00`<br>
`e4 bd a0 e5 a5 bd 00`</p>


Windows ä¸‹çš„ `wcout` ä¸»è¦ç”¨åœ¨é…åˆå®½å­—ç¬¦çš„è¾“å‡ºï¼Œæ­¤å¤–æ²¡ä»€ä¹ˆå¤§ç”¨å¤„ã€‚åŸå› ä¸€æ ·ï¼Œåªæœ‰è¿›è¡Œäº†æ­£ç¡®çš„åŒºåŸŸè®¾ç½®ï¼Œæ‰èƒ½è¾“å‡ºè·Ÿè¯¥åŒºåŸŸç›¸åŒ¹é…çš„å®½å­—ç¬¦ä¸²ï¼ˆä¸åŒ¹é…çš„å­—ç¬¦å°†å¯¼è‡´åç»­è¾“å‡ºå…¨éƒ¨æ¶ˆå¤±ï¼ï¼‰ã€‚å¦‚æœè¦è¾“å‡ºä¸­æ–‡ï¼Œå¾—å†™ `setlocale(LC_ALL, "Chinese_China.936");`ï¼Œè¿™æ˜¾ç„¶å°±è®©â€œç»Ÿä¸€ç â€è¾“å‡ºå¤±å»æ„ä¹‰äº†ã€‚

ä½†æ˜¯ï¼ˆè¿˜æ˜¯æœ‰ä¸ªâ€œä½†æ˜¯â€ï¼‰ï¼Œå¦‚æœä½ **åªç”¨** `wcout`ï¼Œä¸ç”¨ `cout` æˆ–ä»»ä½•ä½¿ç”¨çª„å­—ç¬¦è¾“å‡ºåˆ° `stdout` çš„å‡½æ•°ï¼ˆå¦‚ `puts`ï¼‰ï¼Œè¿™æ—¶å€’æœ‰ä¸ªè¿˜ä¸é”™çš„è§£å†³æ–¹æ¡ˆï¼Œå¯ä»¥åœ¨ç»ˆç«¯è¾“å‡ºå¤šè¯­è¨€ã€‚æˆ‘ä¹Ÿæ˜¯å¶ç„¶æ‰å‘ç°è¿™ä¸€ç”¨æ³•ï¼Œå¹¶ä¸”æ²¡æœ‰åœ¨å¾®è½¯çš„ç½‘ç«™ä¸Šæ‰¾åˆ°æ¸…æ™°çš„æ–‡æ¡£â€¦â€¦ä»£ç å¦‚ä¸‹æ‰€ç¤ºï¼š

```
#include &lt;fcntl.h&gt;
#include &lt;io.h&gt;
#include &lt;iostream&gt;

int main()
{
  _setmode(_fileno(stdout),
           _O_WTEXT);
  std::wcout
    &lt;&lt; L"ä¸­æ–‡ EspaÃ±ol FranÃ§ais\n";
  std::wcout
    &lt;&lt; "Narrow characters are "
       "also OK on wcout\n";
  // but not on cout...
}

```

ç”±äºçª„å­—ç¬¦åœ¨å¤§éƒ¨åˆ† Windows ç³»ç»Ÿä¸Šåªæ”¯æŒä¼ ç»Ÿç¼–ç ï¼Œè¦æ‰“å¼€ä¸€ä¸ªå½“å‰ç¼–ç ä¸æ”¯æŒçš„æ–‡ä»¶åç§°ï¼Œå°±å¿…éœ€ä½¿ç”¨å®½å­—ç¬¦çš„æ–‡ä»¶åã€‚å¾®è½¯çš„ `fstream` ç³»åˆ—ç±»åŠå…¶ `open` æˆå‘˜å‡½æ•°éƒ½æ”¯æŒ `const wchar_t*` ç±»å‹çš„æ–‡ä»¶åï¼Œè¿™æ˜¯ C++ æ ‡å‡†é‡Œæ‰€æ²¡æœ‰çš„ã€‚

### ç»Ÿä¸€åŒ–å¤„ç†

è¦æƒ³å†™å‡ºè·¨å¹³å°çš„å¤„ç†å­—ç¬¦ä¸²çš„ä»£ç ï¼Œæˆ‘ä»¬ä¸€èˆ¬è€ƒè™‘ä¸¤ç§æ–¹å¼ä¹‹ä¸€ï¼š

- æºä»£ç çº§å…¼å®¹ï¼Œä½†å†…ç ä¸åŒ
- æºä»£ç å’Œå†…ç éƒ½å®Œå…¨å…¼å®¹

å¾®è½¯æ¨èçš„æ–¹å¼ä¸€èˆ¬æ˜¯å‰è€…ã€‚åš Windows å¼€å‘çš„äººå¾ˆå¤šéƒ½çŸ¥é“ tchar.h å’Œ `_T` å®ï¼Œå®ƒä»¬å°±èµ·ç€ç±»ä¼¼çš„ä½œç”¨ï¼ˆè™½ç„¶ç›®çš„ä¸åŒï¼‰ã€‚æ ¹æ®é¢„å®šä¹‰å®çš„ä¸åŒï¼Œç³»ç»Ÿä¼šåœ¨åŒä¸€å¥—ä»£ç ä¸‹é€‰æ‹©ä¸åŒçš„ç¼–ç æ–¹å¼åŠå¯¹åº”çš„å‡½æ•°ã€‚æ‹¿ä¸€ä¸ªæœ€å°çš„ä¾‹å­æ¥è¯´ï¼š

```
#include &lt;stdio.h&gt;
#include &lt;tchar.h&gt;

int _tmain(int argc, TCHAR* argv[])
{
  _putts(_T("Hello world!\n"));
}

```

å¦‚æœç”¨ç¼ºçœçš„å‘½ä»¤è¡Œå‚æ•°è¿›è¡Œç¼–è¯‘ï¼Œä¸Šé¢çš„ä»£ç ç›¸å½“äºï¼š

```
#include &lt;stdio.h&gt;

int main(int argc, char* argv[])
{
  puts("Hello world!\n");
}

```

è€Œå¦‚æœåœ¨å‘½ä»¤è¡Œä¸ŠåŠ ä¸Šäº† `/D_UNICODE`ï¼Œé‚£ä»£ç åˆ™ç›¸å½“äºï¼š

```
#include &lt;stdio.h&gt;

int wmain(int argc, wchar_t* argv[])
{
  _putws(L"Hello world!\n");
}

```

å½“ç„¶ï¼Œè¿™ä¸ªä»£ç è¿˜æ˜¯åªèƒ½åœ¨ Windows ä¸Šç”¨ï¼Œå¹¶ä¸”ä»ç„¶ä¸æ¼‚äº®ï¼ˆæ‰€æœ‰çš„å­—ç¬¦å’Œå­—ç¬¦ä¸²å­—é¢é‡éƒ½å¾—å¥—ä¸Š `_T`ï¼‰ã€‚åè€…æ— è§£ï¼Œå‰è€…åˆ™å¯ä»¥æ‰¾åˆ°æ›¿ä»£æ–¹æ¡ˆï¼ˆç”šè‡³è‡ªå·±å†™ä¹Ÿä¸å¤æ‚ï¼‰ã€‚C++ REST SDK ä¸­å°±æä¾›äº†ç±»ä¼¼çš„å°è£…ï¼Œå¯ä»¥è·¨å¹³å°åœ°å¼€å‘ç½‘ç»œåº”ç”¨ã€‚ä½†å¯ä»¥è¯´ï¼Œè¿™ç§æ–¹å¼æ˜¯ä¸€ç§ä¸»è¦ç…§é¡¾ Windows çš„å¼€å‘æ–¹å¼ã€‚

ç›¸åº”çš„ï¼Œå¯¹ Unix å¼€å‘è€…è€Œè¨€æ›´è‡ªç„¶çš„æ–¹å¼æ˜¯å…¨é¢ä½¿ç”¨ UTF-8ï¼Œä»…åœ¨è·Ÿæ“ä½œç³»ç»Ÿã€æ–‡ä»¶ç³»ç»Ÿæ‰“äº¤é“æ—¶æŠŠå­—ç¬¦ä¸²è½¬æ¢æˆéœ€è¦çš„ç¼–ç ã€‚åˆ©ç”¨ä¸´æ—¶å¯¹è±¡çš„ç”Ÿå‘½å‘¨æœŸï¼Œæˆ‘ä»¬å¯ä»¥åƒä¸‹é¢è¿™æ ·å†™å¸®åŠ©å‡½æ•°å’Œå®ã€‚

utf8_to_native.hppï¼š

```
#ifndef UTF8_TO_NATIVE_HPP
#define UTF8_TO_NATIVE_HPP

#include &lt;string&gt;

#if defined(_WIN32) || \
    defined(_UNICODE)

std::wstring utf8_to_wstring(
  const char* str);
std::wstring utf8_to_wstring(
  const std::string&amp; str);

#define NATIVE_STR(s) \
  utf8_to_wstring(s).c_str()

#else

inline const char*
to_c_str(const char* str)
{
  return str;
}

inline const char*
to_c_str(const std::string&amp; str)
{
  return str.c_str();
}

#define NATIVE_STR(s) \
  to_c_str(s)

#endif

#endif // UTF8_TO_NATIVE_HPP

```

utf8_to_native.cppï¼š

```
#include "utf8_to_native.hpp"

#if defined(_WIN32) || \
    defined(_UNICODE)
#include &lt;windows.h&gt;
#include &lt;system_error&gt;

namespace {

void throw_system_error(
  const char* reason)
{
  std::string msg(reason);
  msg += " failed";
  std::error_code ec(
    GetLastError(),
    std::system_category());
  throw std::system_error(ec, msg);
}

} /* unnamed namespace */

std::wstring utf8_to_wstring(
  const char* str)
{
  int len = MultiByteToWideChar(
    CP_UTF8, 0, str, -1,
    nullptr, 0);
  if (len == 0) {
    throw_system_error(
      "utf8_to_wstring");
  }
  std::wstring result(len - 1,
                      L'\0');
  if (MultiByteToWideChar(
        CP_UTF8, 0, str, -1,
        result.data(), len) == 0) {
    throw_system_error(
      "utf8_to_wstring");
  }
  return result;
}

std::wstring utf8_to_wstring(
  const std::string&amp; str)
{
  return utf8_to_wstring(
    str.c_str());
}

#endif

```

åœ¨å¤´æ–‡ä»¶é‡Œï¼Œå®šä¹‰äº†åœ¨ Windows ä¸‹ä¼šåš UTF-8 åˆ° UTF-16 çš„è½¬æ¢ï¼›åœ¨å…¶ä»–ç¯å¢ƒä¸‹åˆ™ä¸çœŸæ­£åšè½¬æ¢ï¼Œè€Œæ˜¯ä¸ç®¡æä¾›çš„æ˜¯å­—ç¬¦æŒ‡é’ˆè¿˜æ˜¯ `string` éƒ½ä¼šè½¬æ¢æˆå­—ç¬¦æŒ‡é’ˆã€‚åœ¨ Windows ä¸‹æ¯æ¬¡è°ƒç”¨ `NATIVE_STR` ä¼šç”Ÿæˆä¸€ä¸ªä¸´æ—¶å¯¹è±¡ï¼Œå½“å‰è¯­å¥æ‰§è¡Œç»“æŸåè¿™ä¸ªä¸´æ—¶å¯¹è±¡ä¼šè‡ªåŠ¨é”€æ¯ã€‚

ä½¿ç”¨è¯¥åŠŸèƒ½çš„ä»£ç æ˜¯è¿™æ ·çš„ï¼š

```
#include &lt;fstream&gt;
#include "utf8_to_native.hpp"

int main()
{
  using namespace std;
  const char filename[] =
    u8"æµ‹è¯•.txt";
  ifstream ifs(
    NATIVE_STR(filename));
  // å¯¹ ifs è¿›è¡Œæ“ä½œ
}

```

ä¸Šé¢è¿™æ ·çš„ä»£ç å¯ä»¥åŒæ—¶é€‚ç”¨äºç°ä»£ Unix å’Œç°ä»£ Windowsï¼ˆä»»ä½•è¯­è¨€è®¾ç½®ä¸‹ï¼‰ï¼Œç”¨æ¥è¯»å–åä¸ºâ€œæµ‹è¯•.txtâ€çš„æ–‡ä»¶ã€‚

## ç¼–ç¨‹æ”¯æŒ

ç»“æŸä¹‹å‰ï¼Œæˆ‘ä»¬å¿«é€Ÿä»‹ç»ä¸€ä¸‹å…¶ä»–çš„ä¸€äº›æ”¯æŒ Unicode åŠå…¶è½¬æ¢çš„ APIã€‚

### Windows API

ä¸Šä¸€èŠ‚çš„ä»£ç åœ¨ Windows ä¸‹ç”¨åˆ°äº† `MultiByteToWideChar` [12]ï¼Œä»æŸä¸ªç¼–ç è½¬åˆ° UTF-16ã€‚Windows ä¹Ÿæä¾›äº†åå‘çš„ `WideCharToMultiByte` [13]ï¼Œä» UTF-16 è½¬åˆ°æŸä¸ªç¼–ç ã€‚ä»ä¸Šé¢å¯ä»¥çœ‹åˆ°ï¼ŒC æ¥å£ç”¨èµ·æ¥å¹¶ä¸æ–¹ä¾¿ï¼Œå¯ä»¥è€ƒè™‘è‡ªå·±å°è£…ä¸€ä¸‹ã€‚

### iconv

Unix ä¸‹æœ€å¸¸ç”¨çš„åº•å±‚ç¼–ç è½¬æ¢æ¥å£æ˜¯ iconv [14]ï¼Œæä¾› `iconv_open`ã€`iconv_close` å’Œ `iconv` ä¸‰ä¸ªå‡½æ•°ã€‚è¿™åŒæ ·æ˜¯ C æ¥å£ï¼Œå®è·µä¸­åº”è¯¥å°è£…ä¸€ä¸‹ã€‚

### ICU4C

ICU [15] æ˜¯ä¸€ä¸ªå®Œæ•´çš„ Unicode æ”¯æŒåº“ï¼Œæä¾›å¤§é‡çš„æ–¹æ³•ï¼ŒICU4C æ˜¯å…¶ C/C++ çš„ç‰ˆæœ¬ã€‚ICU æœ‰ä¸“é—¨çš„å­—ç¬¦ä¸²ç±»å‹ï¼Œå†…ç æ˜¯ UTF-16ï¼Œä½†å¯ä»¥ç›´æ¥ç”¨äº IO streams çš„è¾“å‡ºã€‚ä¸‹é¢çš„ç¨‹åºåº”è¯¥åœ¨æ‰€æœ‰å¹³å°ä¸Šéƒ½æœ‰åŒæ ·çš„è¾“å‡ºï¼ˆä½†åœ¨ Windows ä¸Šè¦æ±‚å½“å‰ç³»ç»Ÿä¼ ç»Ÿç¼–ç èƒ½æ”¯æŒå¾…è¾“å‡ºçš„å­—ç¬¦ï¼‰ï¼š

```
#include &lt;iostream&gt;
#include &lt;string&gt;
#include &lt;unicode/unistr.h&gt;
#include &lt;unicode/ustream.h&gt;

using namespace std;
using icu::UnicodeString;

int main()
{
  auto str = UnicodeString::fromUTF8(
    u8"ä½ å¥½");
  cout &lt;&lt; str &lt;&lt; endl;
  string u8str;
  str.toUTF8String(u8str);
  cout &lt;&lt; "In UTF-8 it is "
       &lt;&lt; u8str.size() &lt;&lt; " bytes"
       &lt;&lt; endl;
}

```

### codecvt

C++11 æ›¾ç»å¼•å…¥äº†ä¸€ä¸ªå¤´æ–‡ä»¶ &lt;codecvt&gt; [16] ç”¨ä½œ UTF ç¼–ç é—´çš„è½¬æ¢ï¼Œä½†å¾ˆé—æ†¾ï¼Œé‚£ä¸ªå¤´æ–‡ä»¶ç›®å‰å·²å› ä¸ºå­˜åœ¨å®‰å…¨æ€§å’Œæ˜“ç”¨æ€§é—®é¢˜è¢«å®£å‘Šæ”¾å¼ƒï¼ˆdeprecatedï¼‰[17]ã€‚&lt;locale&gt; ä¸­æœ‰å¦å¤–ä¸€ä¸ª `codecvt` æ¨¡æ¿ [18]ï¼Œæœ¬èº«æ¥å£ä¸é‚£ä¹ˆå¥½ç”¨ï¼Œè€Œä¸”åˆ° C++20 è¿˜ä¼šå‘ç”Ÿå˜åŒ–ï¼Œè¿™å„¿ä¹Ÿä¸è¯¦ç»†ä»‹ç»äº†ã€‚æœ‰å…´è¶£çš„è¯å¯ä»¥ç›´æ¥çœ‹å‚è€ƒèµ„æ–™ã€‚

## å†…å®¹å°ç»“

æœ¬è®²æˆ‘ä»¬è®¨è®ºäº† Unicodeï¼Œä»¥åŠ C++ ä¸­å¯¹ Unicode çš„æ”¯æŒã€‚æˆ‘ä»¬ä¹Ÿè®¨è®ºäº†åœ¨ä¸¤å¤§ä¸»æµæ¡Œé¢å¹³å°ä¸Šå…³äº Unicode ç¼–ç æ”¯æŒçš„ä¸€äº›æƒ¯ç”¨æ³•ã€‚å¸Œæœ›ä½ åœ¨æœ¬è®²ä¹‹åï¼Œèƒ½æ¸…æ¥šåœ°çŸ¥é“ Unicode å’Œå„ç§ UTF ç¼–ç æ˜¯æ€ä¹ˆå›äº‹ã€‚

## è¯¾åæ€è€ƒ

è¯·æ€è€ƒä¸€ä¸‹ï¼š

1. ä¸ºä»€ä¹ˆè¯´ UTF-32 å¤„ç†ä¼šæ¯”è¾ƒç®€å•ï¼Ÿ
1. ä½ çŸ¥é“ä»€ä¹ˆæƒ…å†µä¸‹ UTF-32 ä¹Ÿå¹¶ä¸é‚£ä¹ˆç®€å•å—ï¼Ÿ
1. å“ªç§ UTF ç¼–ç æ–¹å¼ç©ºé—´å­˜å‚¨æ•ˆç‡æ¯”è¾ƒé«˜ï¼Ÿ

æ¬¢è¿ç•™è¨€ä¸€èµ·è®¨è®ºä¸€ä¸‹ã€‚

## å‚è€ƒèµ„æ–™

[1] Wikipedia, â€œASCIIâ€. [https://en.wikipedia.org/wiki/ASCII](https://en.wikipedia.org/wiki/ASCII) 

[2] Wikipedia, â€œEBCDICâ€. [https://en.wikipedia.org/wiki/EBCDIC](https://en.wikipedia.org/wiki/EBCDIC) 

[3] Wikipedia, â€œGB 2312â€. [https://en.wikipedia.org/wiki/GB_2312](https://en.wikipedia.org/wiki/GB_2312) 

[3a] ç»´åŸºç™¾ç§‘, â€œGB 2312â€. [https://zh.wikipedia.org/zh-cn/GB_2312](https://zh.wikipedia.org/zh-cn/GB_2312) 

[4] Wikipedia, â€œEUC-CNâ€. [https://en.wikipedia.org/wiki/Extended_Unix_Code#EUC-CN](https://en.wikipedia.org/wiki/Extended_Unix_Code#EUC-CN) 

[4a] ç»´åŸºç™¾ç§‘, â€œEUC-CNâ€. [https://zh.wikipedia.org/zh-cn/EUC#EUC-CN](https://zh.wikipedia.org/zh-cn/EUC#EUC-CN) 

[5] Wikipedia, â€œGBKâ€. [https://en.wikipedia.org/wiki/GBK_(character_encoding)](https://en.wikipedia.org/wiki/GBK_(character_encoding)) 

[5a] ç»´åŸºç™¾ç§‘, â€œæ±‰å­—å†…ç æ‰©å±•è§„èŒƒâ€. [https://zh.wikipedia.org/zh-cn/æ±‰å­—å†…ç æ‰©å±•è§„èŒƒ](https://zh.wikipedia.org/zh-cn/%E6%B1%89%E5%AD%97%E5%86%85%E7%A0%81%E6%89%A9%E5%B1%95%E8%A7%84%E8%8C%83) 

[6] Wikipedia, â€œUnicodeâ€. [https://en.wikipedia.org/wiki/Unicode](https://en.wikipedia.org/wiki/Unicode) 

[6a] ç»´åŸºç™¾ç§‘, â€œUnicodeâ€. [https://zh.wikipedia.org/zh-cn/Unicode](https://zh.wikipedia.org/zh-cn/Unicode) 

[7] å´å’ç‚œ, â€œSpecify LANG in a UTF-8 web pageâ€. [http://wyw.dcweb.cn/lang_utf8.htm](http://wyw.dcweb.cn/lang_utf8.htm) 

[8] Wikipedia, â€œUTF-32â€. [https://en.wikipedia.org/wiki/UTF-32](https://en.wikipedia.org/wiki/UTF-32) 

[9] Wikipedia, â€œUTF-16â€. [https://en.wikipedia.org/wiki/UTF-16](https://en.wikipedia.org/wiki/UTF-16) 

[10] Wikipedia, â€œUTF-8â€. [https://en.wikipedia.org/wiki/UTF-8](https://en.wikipedia.org/wiki/UTF-8) 

[11] Wikipedia, â€œByte order markâ€. [https://en.wikipedia.org/wiki/Byte_order_mark](https://en.wikipedia.org/wiki/Byte_order_mark) 

[11a] ç»´åŸºç™¾ç§‘, â€œå­—èŠ‚é¡ºåºæ ‡è®°â€. [https://zh.wikipedia.org/zh-cn/ä½å…ƒçµ„é †åºè¨˜è™Ÿ](https://zh.wikipedia.org/zh-cn/%E4%BD%8D%E5%85%83%E7%B5%84%E9%A0%86%E5%BA%8F%E8%A8%98%E8%99%9F) 

[12] Microsoft, â€œMultiByteToWideChar functionâ€. [https://docs.microsoft.com/en-us/windows/win32/api/stringapiset/nf-stringapiset-multibytetowidechar](https://docs.microsoft.com/en-us/windows/win32/api/stringapiset/nf-stringapiset-multibytetowidechar) 

[13] Microsoft, â€œWideCharToMultiByte functionâ€. [https://docs.microsoft.com/en-us/windows/win32/api/stringapiset/nf-stringapiset-widechartomultibyte](https://docs.microsoft.com/en-us/windows/win32/api/stringapiset/nf-stringapiset-widechartomultibyte) 

[14] Wikipedia, â€œiconvâ€. [https://en.wikipedia.org/wiki/Iconv](https://en.wikipedia.org/wiki/Iconv) 

[15] ICU Technical Committee, ICUâ€”International Components for Unicode. [http://site.icu-project.org/](http://site.icu-project.org/) 

[16] cppreference.com, â€œStandard library header &lt;codecvt&gt;â€. [https://en.cppreference.com/w/cpp/header/codecvt](https://en.cppreference.com/w/cpp/header/codecvt) 

[17] Alisdair Meredith, â€œDeprecating &lt;codecvt&gt;â€. [http://www.open-std.org/jtc1/sc22/wg21/docs/papers/2017/p0618r0.html](http://www.open-std.org/jtc1/sc22/wg21/docs/papers/2017/p0618r0.html) 

[18] cppreference.com, â€œstd::codecvtâ€. [https://en.cppreference.com/w/cpp/locale/codecvt](https://en.cppreference.com/w/cpp/locale/codecvt) 
